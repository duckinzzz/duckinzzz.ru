{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clech Royale Stats</title>
    <link rel="icon" type="image/png" href="{% static 'crstats/images/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'crstats/css/styles.css' %}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üèÜ Clech Royale Stats</h1>
        <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç—Ä–æ—Ñ–µ–µ–≤ –ø–æ –±–æ—è–º</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="playerSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞:</label>
            <select id="playerSelect"></select>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot win"></div>
            <span>–ü–æ–±–µ–¥–∞ (+—Ç—Ä–æ—Ñ–µ–∏)</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot loss"></div>
            <span>–ü–æ—Ä–∞–∂–µ–Ω–∏–µ (-—Ç—Ä–æ—Ñ–µ–∏)</span>
        </div>
    </div>

    <div class="main-content">
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="battleChart"></canvas>
            </div>
            <div id="customHover"></div>
        </div>

        <div class="last-battles">
            <h3>üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–æ–∏</h3>
            <ul>
                {% for battle in last_battles %}
                    <li class="battle-row">
                        <div class="battle-main">
                            <span class="player">{{ battle.player }}</span>
                            <span class="trophies">{{ battle.before }}</span>
                            <span class="change {% if battle.change > 0 %}win{% else %}loss{% endif %}">
                            {% if battle.change > 0 %}+{% endif %}{{ battle.change }}</span>
                        </div>
                        <div class="battle-time">{{ battle.ago }}</div>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="stats-info">
        –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 90 —Å–µ–∫—É–Ω–¥
    </div>
</div>

<script>
    const ctx = document.getElementById('battleChart').getContext('2d');
    const hoverDiv = document.getElementById('customHover');
    const select = document.getElementById('playerSelect');
    const dataObj = {{ data|safe }};
    const defaultPlayer = "{{ default_player }}";

    function buildCardsLayout(cards) {
        return cards.map(c => {
            const iconUrl = (c.isEvo === 'True' && c.iconUrls.evolutionMedium)
                ? c.iconUrls.evolutionMedium
                : c.iconUrls.medium;
            return `<img src="${iconUrl}" alt="${c.name}" title="${c.name}" />`;
        }).join('');
    }

    function buildTooltipHTML(pointData) {
        if (!pointData || !pointData.battle_info) return `<div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
        const info = pointData.battle_info;

        // Get scores (crowns)
        const playerCrowns = info.player.crowns || 0;
        const enemyCrowns = info.enemy.crowns || 0;

        // Calculate average levels
        const playerAvgLevel = (info.player.cards.reduce((sum, c) => sum + c.level, 0) / info.player.cards.length).toFixed(1);
        const enemyAvgLevel = (info.enemy.cards.reduce((sum, c) => sum + c.level, 0) / info.enemy.cards.length).toFixed(1);

        function calculateAdjustedAvg(cards) {
            const nonZeroCards = cards.filter(c => c.elixirCost !== 0);
            const zeroCard = cards.find(c => c.elixirCost === 0);

            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ä–µ–¥–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç
            const minCost = Math.min(...nonZeroCards.map(c => c.elixirCost));
            const maxCost = Math.max(...nonZeroCards.map(c => c.elixirCost));

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∞ —Å elixirCost = 0
            if (zeroCard) {
                const avgMin = (nonZeroCards.reduce((sum, c) => sum + c.elixirCost, 0) + (minCost + 1)) / cards.length;
                const avgMax = (nonZeroCards.reduce((sum, c) => sum + c.elixirCost, 0) + (maxCost + 1)) / cards.length;
                return ((avgMin + avgMax) / 2).toFixed(1);
            } else {
                // –ü—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π
                const avg = cards.reduce((sum, c) => sum + (c.elixirCost || 0), 0) / cards.length;
                return avg.toFixed(1);
            }
        }

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        const playerAvgCost = calculateAdjustedAvg(info.player.cards);
        const enemyAvgCost = calculateAdjustedAvg(info.enemy.cards);
        return `
        <div class="tooltip-header">
            <div><strong>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫:</strong> ${info.enemy.nickname}</div>
            <div><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <span class="${pointData.change > 0 ? 'win' : 'loss'}">${pointData.change > 0 ? '–ü–æ–±–µ–¥–∞' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ'} (${pointData.change > 0 ? '+' : ''}${pointData.change})</span></div>
            <div><strong>–í—Ä–µ–º—è:</strong> ${pointData.battle_time}</div>
        </div>
        <hr/>
        <div class="battle-layout">
            <div class="deck-column">
                <div class="deck-label">–í–∞—à–∏ –∫–∞—Ä—Ç—ã</div>
                <div class="player-cards">
                    ${buildCardsLayout(info.player.cards)}
                </div>
                <div class="deck-stats">
                    <div class="stat-item">avg lvl: ${playerAvgLevel}</div>
                    <div class="stat-item">avg cost: ${playerAvgCost}</div>
                </div>
            </div>
            <div class="score-divider">
                <div class="score">–°—á–µ—Ç ${playerCrowns}:${enemyCrowns}</div>
            </div>
            <div class="deck-column">
                <div class="deck-label">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</div>
                <div class="enemy-cards">
                    ${buildCardsLayout(info.enemy.cards)}
                </div>
                <div class="deck-stats">
                    <div class="stat-item">avg lvl: ${enemyAvgLevel}</div>
                    <div class="stat-item">avg cost: ${enemyAvgCost}</div>
                </div>
            </div>
        </div>
    `;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –∏–≥—Ä–æ–∫–∞–º–∏
    Object.keys(dataObj).forEach(player => {
        const option = document.createElement('option');
        option.value = player;
        option.textContent = player;
        if (player === defaultPlayer) option.selected = true;
        select.appendChild(option);
    });

    let battleChart;

    function renderChart(playerName) {
        const playerData = dataObj[playerName];
        if (!playerData) return;

        const total = playerData.x.length;
        const start = Math.max(0, total - 20); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –±–æ—ë–≤

        const chartData = {
            labels: playerData.x.slice(start),
            datasets: [{
                label: '–¢—Ä–æ—Ñ–µ–∏',
                data: playerData.y.slice(start),
                backgroundColor: playerData.custom.slice(start).map(c => c.change > 0 ? '#28a745' : '#dc3545'),
                borderColor: '#667eea',
                borderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: playerData.custom.slice(start).map(c => c.change > 0 ? '#28a745' : '#dc3545'),
                custom: playerData.custom.slice(start)
            }]
        };

        if (battleChart instanceof Chart) battleChart.destroy();

        battleChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        enabled: false,
                        external: context => {
                            const point = context.tooltip.dataPoints?.[0];
                            if (!point || !point.dataset?.custom) {
                                hoverDiv.style.display = 'none';
                                return;
                            }
                            const pointData = point.dataset.custom[point.dataIndex];
                            if (!pointData) {
                                hoverDiv.style.display = 'none';
                                return;
                            }

                            const canvasRect = ctx.canvas.getBoundingClientRect();
                            hoverDiv.innerHTML = buildTooltipHTML(pointData);

                            // Position tooltip
                            const tooltipX = point.element.x + 15;
                            const tooltipY = point.element.y - 10;

                            hoverDiv.style.left = tooltipX + 'px';
                            hoverDiv.style.top = tooltipY + 'px';
                            hoverDiv.style.display = 'block';
                        }
                    }
                },
                scales: {
                    x: {title: {display: true, text: '–ù–æ–º–µ—Ä –±–æ—è'}},
                    y: {title: {display: true, text: '–¢—Ä–æ—Ñ–µ–∏'}, beginAtZero: false}
                }
            }
        });
    }

    // –ó–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    renderChart(defaultPlayer);
    select.addEventListener('change', e => renderChart(e.target.value));

    // Hide tooltip when mouse leaves chart
    ctx.canvas.addEventListener('mouseleave', () => {
        hoverDiv.style.display = 'none';
    });
</script>
</body>
</html>